#!/usr/bin/env bash

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

set -e

# Helper functions
puts-step() {
  echo "-----> $*"
}

# Install TA-Lib C library
puts-step "Installing TA-Lib C library"
TALIB_SRC_URL="http://prdownloads.sourceforge.net/ta-lib/ta-lib-0.4.0-src.tar.gz"
TALIB_BUILD_DIR="$BUILD_DIR/ta-lib"
TALIB_INSTALL_DIR="/app/.heroku/vendor/ta-lib"

# Download and compile TA-Lib
mkdir -p $TALIB_BUILD_DIR
curl -fsSL $TALIB_SRC_URL | tar -xz -C $TALIB_BUILD_DIR --strip-components=1
cd $TALIB_BUILD_DIR
./configure --prefix=$TALIB_INSTALL_DIR --disable-static
make
make install

# Update library path
export LD_LIBRARY_PATH="$TALIB_INSTALL_DIR/lib:$LD_LIBRARY_PATH"
export CFLAGS="-I$TALIB_INSTALL_DIR/include"

# Install Python dependencies
puts-step "Installing Python requirements"
pip install -r $BUILD_DIR/requirements.txt

# Install TA-Lib Python wrapper
puts-step "Installing TA-Lib Python wrapper"
pip install TA-Lib

puts-step "Buildpack installation complete"
